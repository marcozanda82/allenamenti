<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Programma Allenamento Ab Wheel</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; line-height: 1.6; background-color: #f4f4f9; color: #333; margin: 0; padding: 20px; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .container { max-width: 700px; width: 100%; background: #fff; padding: 25px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h1, h2, h3 { text-align: center; color: #2c3e50; }
        .config-section, .notification-section { background-color: #f8f9f9; border: 1px solid #e0e0e0; padding: 15px; margin: 20px 0; border-radius: 8px; }
        .config-section label { font-weight: bold; margin-right: 10px; }
        .config-section select { padding: 8px; border-radius: 5px; border: 1px solid #ccc; font-size: 1em; }
        .status-box { padding: 15px; border-radius: 8px; margin: 20px 0; text-align: center; font-size: 1.2em; font-weight: bold; }
        .workout-day { background-color: #e8f5e9; border: 2px solid #4caf50; color: #2e7d32; }
        .rest-day { background-color: #fff3e0; border: 2px solid #fb8c00; color: #e65100; }
        #workout-plan-container { background-color: #ecf0f1; border: 2px solid #bdc3c7; padding: 20px; margin-top: 20px; border-radius: 8px; }
        .workout-form { display: flex; flex-direction: column; gap: 15px; margin: 25px 0; }
        .workout-form button { padding: 12px; background-color: #3498db; color: white; border: none; border-radius: 5px; font-size: 1.1em; cursor: pointer; }
        #history-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        #history-table th, #history-table td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        .backup-section { margin-top: 40px; padding-top: 20px; border-top: 2px dashed #bdc3c7; }
        .backup-section button { background-color: #16a085; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Programma Allenamento Ab Wheel</h1>
        
        <div class="config-section">
            <h3>Imposta il Tuo Piano</h3>
            <label for="workout-option">Scegli la tua routine:</label>
            <select id="workout-option">
                <option value="1">Opzione 1: Flessibile (1gg sì, 1gg no)</option>
                <option value="2">Opzione 2: Giorni Fissi (Lunedì & Mercoledì)</option>
            </select>
        </div>

        <div id="status-box-container">
            <div id="workout-status" class="status-box"></div>
        </div>
        
        <div id="workout-plan-container"></div>
        <form class="workout-form" id="log-form"></form>
        
        <h2>Storico Allenamenti</h2>
        <table id="history-table">
            <thead><tr><th>Data</th><th>Serie</th><th>Ripetizioni</th><th>Piano</th></tr></thead>
            <tbody id="history-body"></tbody>
        </table>

        <div class="notification-section">
            <h3>Promemoria Allenamento</h3>
            <p>Ricevi una notifica alle 12:00 nei giorni di allenamento. Clicca il pulsante per attivare.</p>
            <p><small><strong>Importante:</strong> Funziona solo se questa pagina è aperta nel browser del tuo telefono o computer.</small></p>
            <button id="enable-notifications">Attiva Notifiche</button>
        </div>

        <div class="backup-section">
            </div>
    </div>

    <script>
        try {
            document.addEventListener('DOMContentLoaded', () => {
                // --- SELEZIONE ELEMENTI ---
                const optionSelect = document.getElementById('workout-option');
                const workoutStatusEl = document.getElementById('workout-status');
                const planContainer = document.getElementById('workout-plan-container');
                const logFormContainer = document.getElementById('log-form');
                const historyBody = document.getElementById('history-body');
                const notificationsBtn = document.getElementById('enable-notifications');

                // Carica la scelta salvata dell'utente
                const savedOption = localStorage.getItem('abWheelOption') || '1';
                optionSelect.value = savedOption;
                
                // --- LOGICA DI ALLENAMENTO ---
                const isWorkoutDay = (option, today, history) => {
                    const todayDay = today.getDay(); // 0=Domenica, 1=Lunedì, ..., 6=Sabato
                    const lastEntry = history.length > 0 ? history[history.length - 1] : null;

                    // Controlla se si è già allenato oggi
                    if (lastEntry && lastEntry.date === today.toLocaleDateString('it-IT')) {
                        return false; 
                    }

                    if (option === '1') { // Opzione 1: Flessibile (1gg sì, 1gg no)
                        if (!lastEntry) return true; // Se non c'è storico, può sempre allenarsi
                        
                        const lastDate = new Date(lastEntry.date.split('/').reverse().join('-'));
                        const yesterday = new Date();
                        yesterday.setDate(today.getDate() - 1);
                        
                        // Se l'ultimo allenamento è stato ieri, oggi è riposo. Altrimenti è allenamento.
                        return lastDate.setHours(0,0,0,0) !== yesterday.setHours(0,0,0,0);

                    } else if (option === '2') { // Opzione 2: Giorni Fissi
                        // È Lunedì (1) o Mercoledì (3)?
                        return todayDay === 1 || todayDay === 3;
                    }
                    return false;
                };

                // --- FUNZIONE PRINCIPALE DI AGGIORNAMENTO PAGINA ---
                const updatePage = () => {
                    const currentOption = optionSelect.value;
                    const today = new Date();
                    let history = JSON.parse(localStorage.getItem('abWheelHistory')) || [];
                    
                    const workoutToday = isWorkoutDay(currentOption, today, history);
                    
                    if (workoutToday) {
                        workoutStatusEl.textContent = 'Oggi è un giorno di ALLENAMENTO!';
                        workoutStatusEl.className = 'status-box workout-day';
                        planContainer.style.display = 'block';
                        // Popola il form solo se serve
                        logFormContainer.innerHTML = `
                            <h2>Registra l'allenamento</h2>
                            <div><label for="sets">Serie:</label><input type="number" id="sets" required></div>
                            <div><label for="reps">Ripetizioni:</label><input type="number" id="reps" required></div>
                            <button type="submit">Ho Finito!</button>
                        `;
                        logFormContainer.style.display = 'flex';
                        
                        // Aggiunge l'event listener al form appena creato
                        document.getElementById('log-form').addEventListener('submit', handleFormSubmit);

                    } else {
                        workoutStatusEl.textContent = 'Oggi è un giorno di RIPOSO.';
                        workoutStatusEl.className = 'status-box rest-day';
                        planContainer.style.display = 'none';
                        logFormContainer.style.display = 'none';
                        logFormContainer.innerHTML = ''; // Svuota il form
                    }
                    updateHistoryTable(history);
                    updateWorkoutPlan(history);
                };
                
                // Gestisce il salvataggio dell'opzione
                optionSelect.addEventListener('change', () => {
                    localStorage.setItem('abWheelOption', optionSelect.value);
                    updatePage(); // Ricarica la logica della pagina
                });

                // --- GESTIONE STORICO E FORM ---
                 const handleFormSubmit = (e) => {
                    e.preventDefault();
                    let history = JSON.parse(localStorage.getItem('abWheelHistory')) || [];
                    history.push({ 
                        date: new Date().toLocaleDateString('it-IT'), 
                        sets: document.getElementById('sets').value, 
                        reps: document.getElementById('reps').value,
                        plan: optionSelect.value // Salva l'opzione usata
                    });
                    localStorage.setItem('abWheelHistory', JSON.stringify(history));
                    updatePage();
                };

                const updateHistoryTable = (h) => {
                    historyBody.innerHTML = ''; 
                    h.slice().reverse().forEach(e => { // Mostra i più recenti in alto
                        const r = document.createElement('tr'); 
                        r.innerHTML = `<td>${e.date}</td><td>${e.sets}</td><td>${e.reps}</td><td>Opz. ${e.plan}</td>`; 
                        historyBody.appendChild(r);
                    });
                };

                // Funzione per il piano di allenamento (livelli)
                const updateWorkoutPlan = (h) => { /*...logica livelli invariata...*/ };

                // --- LOGICA NOTIFICHE ---
                const handleNotifications = () => {
                    if (!('Notification' in window)) {
                        alert('Questo browser non supporta le notifiche desktop.');
                        return;
                    }
                    Notification.requestPermission().then(permission => {
                        if (permission === 'granted') {
                            alert('Notifiche attivate! Riceverai un promemoria alle 12:00 nei giorni di allenamento, solo se questa pagina è aperta.');
                            // Controlla ogni 5 minuti se è ora di notificare
                            setInterval(checkForNotification, 300000); 
                        } else {
                            alert('Non hai dato il permesso per le notifiche.');
                        }
                    });
                };
                
                const checkForNotification = () => {
                    const now = new Date();
                    const alreadySentToday = localStorage.getItem('notificationSentDate') === now.toLocaleDateString('it-IT');
                    
                    // Controlla se sono le 12:00 e non è già stata mandata oggi
                    if (now.getHours() === 12 && now.getMinutes() < 5 && !alreadySentToday) {
                        const workoutToday = isWorkoutDay(optionSelect.value, now, JSON.parse(localStorage.getItem('abWheelHistory')) || []);
                        if (workoutToday) {
                            new Notification('Promemoria Allenamento Ab Wheel', {
                                body: 'È ora di allenarsi! Oggi è un giorno per il tuo core.',
                                icon: 'https://cdn-icons-png.flaticon.com/512/2964/2964514.png' // Icona generica di un manubrio
                            });
                            localStorage.setItem('notificationSentDate', now.toLocaleDateString('it-IT'));
                        }
                    }
                    // Resetta il flag a mezzanotte
                    if (now.getHours() === 0 && now.getMinutes() < 5) {
                        localStorage.removeItem('notificationSentDate');
                    }
                };

                notificationsBtn.addEventListener('click', handleNotifications);
                
                // --- AVVIO PAGINA ---
                updatePage();
                // Aggiungere qui le altre funzioni come backup/ripristino se necessario
            });
        } catch (e) {
            document.body.innerHTML = `<h1>Oops! Qualcosa è andato storto.</h1><p>Errore: ${e.message}</p>`;
        }
    </script>
</body>
</html>
